import streamlit as st
import pandas as pd
from janome.tokenizer import Tokenizer
from collections import Counter
from wordcloud import WordCloud
import matplotlib.pyplot as plt
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.cluster import KMeans
from io import BytesIO

# --- ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç† ---
def extract_words(texts):
    t = Tokenizer()
    words = []
    for text in texts:
        tokens = t.tokenize(str(text))
        words += [token.base_form for token in tokens 
                  if token.part_of_speech.startswith("åè©")]
    return words

def count_words(words, top_n=30):
    return Counter(words).most_common(top_n)

def cluster_texts(texts, n_clusters=3):
    vectorizer = TfidfVectorizer(tokenizer=lambda x: extract_words([x]), stop_words="english")
    X = vectorizer.fit_transform(texts)
    model = KMeans(n_clusters=n_clusters, random_state=42)
    labels = model.fit_predict(X)
    return labels

# --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ---
st.title("æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆãƒã‚¤ãƒ‹ãƒ³ã‚°ï¼ˆã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚° + ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ï¼‰")

uploaded_file = st.file_uploader("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š'comment'åˆ—ï¼‰", type="csv")

if uploaded_file is not None:
    df = pd.read_csv(uploaded_file)
    column = st.selectbox("åˆ†æå¯¾è±¡ã®åˆ—ã‚’é¸æŠ", df.columns)
    texts = df[column].dropna().tolist()
    
    # å˜èªæŠ½å‡ºãƒ»é »åº¦
    words = extract_words(texts)
    freqs = count_words(words)
    
    st.subheader("ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰")
    wc = WordCloud(font_path="C:/Windows/Fonts/meiryo.ttc", background_color="white", width=800, height=400)
    wc.generate_from_frequencies(dict(freqs))
    plt.figure(figsize=(10, 5))
    plt.imshow(wc, interpolation='bilinear')
    plt.axis("off")
    st.pyplot(plt)
    
    st.subheader("ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°")
    n_clusters = st.slider("ã‚¯ãƒ©ã‚¹ã‚¿æ•°", 2, 10, 3)
    labels = cluster_texts(texts, n_clusters)
    df["Cluster"] = labels
    st.dataframe(df[[column, "Cluster"]])
    
    st.subheader("çµæœã®Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰")
    freq_df = pd.DataFrame(freqs, columns=["Word", "Frequency"])
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, sheet_name="Clustered Texts", index=False)
        freq_df.to_excel(writer, sheet_name="Word Frequencies", index=False)
    st.download_button("ğŸ“¥ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", data=output.getvalue(),
                       file_name="text_mining_result.xlsx", mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")